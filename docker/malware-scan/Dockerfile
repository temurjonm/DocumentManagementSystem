FROM node:20-alpine AS builder

WORKDIR /build

COPY package*.json ./
COPY tsconfig.json ./
COPY src ./src

RUN npm ci
RUN npm run build

FROM clamav/clamav:latest

RUN apk add --no-cache nodejs npm

WORKDIR /app

COPY --from=builder /build/dist ./dist
COPY --from=builder /build/node_modules ./node_modules
COPY --from=builder /build/package.json ./

COPY docker/malware-scan/worker.sh ./worker.sh
RUN chmod +x ./worker.sh

RUN freshclam

CMD ["/app/worker.sh"]
